from __future__ import annotations
import json
import time
import urllib.request
import urllib.error
from typing import Any, Dict, List, Optional


def _post_json(url: str, payload: dict, timeout_s: int) -> dict:
    data = json.dumps(payload).encode("utf-8")
    req = urllib.request.Request(
        url,
        data=data,
        headers={"Content-Type": "application/json"},
        method="POST",
    )
    with urllib.request.urlopen(req, timeout=timeout_s) as resp:
        raw = resp.read().decode("utf-8", errors="replace")
    return json.loads(raw)


def ollama_chat(
    base_url: str,
    model: str,
    messages: List[Dict[str, str]],
    temperature: float = 0.2,
    timeout_s: int = 180,
    retries: int = 2,
) -> str:
    """
    Non-streaming chat. Returns content string.
    Raises RuntimeError on failure.
    """
    url = base_url.rstrip("/") + "/api/chat"
    payload = {
        "model": model,
        "messages": messages,
        "stream": False,
        "options": {"temperature": temperature},
    }

    last_err: Optional[Exception] = None
    for attempt in range(1, retries + 2):
        try:
            out = _post_json(url, payload, timeout_s=timeout_s)
            msg = out.get("message") or {}
            content = msg.get("content")
            if not isinstance(content, str):
                raise RuntimeError(f"Unexpected Ollama response shape: {out}")
            return content
        except (urllib.error.URLError, urllib.error.HTTPError, TimeoutError, json.JSONDecodeError) as e:
            last_err = e
            # small backoff
            time.sleep(min(2.0 * attempt, 6.0))

    raise RuntimeError(f"Ollama chat failed after {retries+1} attempts: {last_err}")
